<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SVG Remote Gallery</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    body { padding: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 1rem; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.5rem; display:flex; flex-direction:column; gap:0.5rem; align-items:center; }
    .thumb { width: 100%; height: 160px; display:flex; align-items:center; justify-content:center; background:#fff; border-radius:4px; overflow:hidden; }
    .thumb img { max-width:100%; max-height:100%; display:block; }
    .meta { font-size:0.85rem; color:#333; text-align:center; }
    .pager { display:flex; gap:0.5rem; align-items:center; margin-bottom:1rem; }
    .gallery-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .gallery-title { margin:0; }
    .status { margin-bottom:0.75rem; color:#333; }
    .page-info { min-width:180px; display:inline-block; text-align:center; }
    .goto-input { width:6rem; margin-left:0.5rem; }
    .overlay-close { float:right; }
    /* Modal zoom */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .overlay .box { max-width: 95%; max-height: 95%; background: white; border-radius: 8px; padding: 0.5rem; overflow: auto; }
    .overlay .box img, .overlay .box object { max-width: 100%; max-height: 80vh; display: block; margin: 0 auto; }
    .overlay.show { display: flex; }
  </style>
</head>
<body>
  <header class="gallery-header">
    <h2 class="gallery-title">SVG Remote Gallery</h2>
    <div>
      <a class="small" href="/svg/remote/index.html">Code Browser</a>
      <a class="small secondary" href="/index.html">Open App</a>
    </div>
  </header>
  <div id="status" class="status" aria-live="polite"></div>

  <div class="pager" aria-label="pagination">
    <label>Page size: <select id="pageSize"><option>25</option><option selected>50</option><option>100</option></select></label>
    <button id="prev" class="small">Previous</button>
    <span id="pageInfo" class="page-info"></span>
    <button id="next" class="small">Next</button>
    <input id="goto" class="goto-input" placeholder="Go to page #" />
    <button id="goBtn" class="small secondary">Go</button>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div id="overlay" class="overlay" role="dialog" aria-hidden="true">
    <div class="box">
      <button id="closeOverlay" class="small secondary overlay-close">Close</button>
      <div id="overlayContent"></div>
    </div>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const pageInfo = document.getElementById('pageInfo');
    const prev = document.getElementById('prev');
    const next = document.getElementById('next');
    const pageSizeSelect = document.getElementById('pageSize');
    const goto = document.getElementById('goto');
    const goBtn = document.getElementById('goBtn');

    let items = [];
    let page = 1;
    let pageSize = parseInt(pageSizeSelect.value, 10) || 50;

    function basename(p) {
      return p.split('/').pop();
    }

    function renderPage() {
      grid.innerHTML = '';
      const total = items.length;
      const pages = Math.max(1, Math.ceil(total / pageSize));
      if (page < 1) page = 1;
      if (page > pages) page = pages;
      const start = (page - 1) * pageSize;
      const slice = items.slice(start, start + pageSize);
      slice.forEach(item => {
        try {
          const card = document.createElement('div'); card.className = 'card';
        const thumb = document.createElement('div'); thumb.className = 'thumb';
        // Use <object> for SVG thumbnails so internal <style> and CSS features
        // (color-mix(), currentColor, CSS vars) render as they do when opened
        // directly. Fall back to <img> if object loading fails.
        const obj = document.createElement('object');
        obj.type = 'image/svg+xml';
        obj.style.width = '100%'; obj.style.height = '100%'; obj.style.display = 'block';
        obj.style.cursor = 'zoom-in';
        // prefer local filename (basename) but fall back to remote url when load fails
        const base = item.filename ? basename(item.filename) : '';
        const localSrc = base ? `./${base}` : '';
        const remoteSrc = item.url || '';
        const initialSrc = localSrc || remoteSrc || (item.filename || '');

        // Create action links early so setResolvedSrc can update their hrefs safely.
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='0.4rem'; actions.style.marginTop='0.25rem';
        const openBtn = document.createElement('a'); openBtn.className='small'; openBtn.href = initialSrc; openBtn.target = '_blank'; openBtn.textContent = 'Open';
        openBtn.addEventListener('click', (e) => { e.preventDefault(); showOverlay(item, localSrc, remoteSrc); });
        const dlBtn = document.createElement('a'); dlBtn.className='small secondary'; dlBtn.href = initialSrc; dlBtn.download = ''; dlBtn.textContent = 'Download';
        actions.appendChild(openBtn); actions.appendChild(dlBtn);
        // attach actions to card after thumb/meta appended

        // Resolve whether the local file actually exists before choosing src.
        // Use HEAD to avoid fetching full content; fall back to remote if missing.
        const setResolvedSrc = (src) => {
          try { obj.data = src; } catch (e) { }
          try { openBtn.href = src; } catch (e) {}
          try { dlBtn.href = src; } catch (e) {}
        };
        if (localSrc) {
          fetch(localSrc, { method: 'HEAD', cache: 'no-store' }).then(r => {
            if (r.ok) setResolvedSrc(localSrc);
            else setResolvedSrc(remoteSrc || localSrc);
          }).catch(() => { setResolvedSrc(remoteSrc || localSrc); });
        } else {
          setResolvedSrc(remoteSrc || initialSrc);
        }
        // if object fails (some servers or browsers), fallback to <img>
        obj.onerror = () => {
          const i = document.createElement('img');
          i.alt = item.id ? `SVG ${item.id}` : (item.filename || 'SVG');
          i.style.maxWidth = '100%'; i.style.maxHeight = '100%'; i.style.display = 'block';
          i.style.cursor = 'zoom-in';
          // ensure open/download link update
          try { i.src = obj.data || remoteSrc || initialSrc; } catch (e) { i.src = remoteSrc || initialSrc; }
          i.onerror = () => { if (remoteSrc && i.src !== remoteSrc) i.src = remoteSrc; };
          i.addEventListener('click', () => showOverlay(item, localSrc, remoteSrc));
          // replace object with img fallback in the thumb
          thumb.innerHTML = '';
          thumb.appendChild(i);
        };
        // clicking thumbnail opens modal zoom
        obj.addEventListener('click', () => showOverlay(item, localSrc, remoteSrc));
        thumb.appendChild(obj);
        card.appendChild(thumb);

        const meta = document.createElement('div'); meta.className = 'meta';
        meta.innerHTML = `<div>${item.id || ''}</div><div style="font-size:0.75rem;color:#666">${item.filename || item.url || ''}</div>`;
        card.appendChild(meta);

        card.appendChild(actions);

          grid.appendChild(card);
        } catch (err) {
          console.error('Error rendering item', item && item.id, err);
        }
      });
      pageInfo.textContent = `Showing ${start + 1}-${Math.min(start + pageSize, items.length)} of ${items.length} (page ${page}/${pages})`;
    }

    pageSizeSelect.addEventListener('change', () => { pageSize = parseInt(pageSizeSelect.value,10); page = 1; renderPage(); });
    prev.addEventListener('click', () => { page--; renderPage(); });
    next.addEventListener('click', () => { page++; renderPage(); });
    goBtn.addEventListener('click', () => { const p = parseInt(goto.value,10); if (!isNaN(p)) { page = p; renderPage(); } });

    async function loadIndex() {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Loading index.json...';
      try {
        const res = await fetch('index.json');
        statusEl.textContent = `index.json fetch: ${res.status} ${res.statusText}`;
        if (!res.ok) throw new Error('index.json not found (status ' + res.status + ')');
        let idx;
        try {
          idx = await res.json();
        } catch (jerr) {
          const txt = await res.text();
          console.error('Failed to parse index.json, snippet:', txt.slice(0,500));
          statusEl.textContent = 'Failed to parse index.json (see console)';
          grid.innerHTML = '<div style="grid-column:1/-1;color:#666">Failed to parse index.json. Check server or file contents.</div>';
          return;
        }
        items = idx.items || [];
        statusEl.textContent = `Loaded ${items.length} items`;
        renderPage();
      } catch (err) {
        console.error('Error loading index.json', err);
        statusEl.textContent = 'Error loading index.json: ' + (err && err.message ? err.message : String(err));
        grid.innerHTML = '<div style="grid-column:1/-1;color:#666">No index.json found in this folder. Run the collector to populate svg/remote/index.json.</div>';
      }
    }

    loadIndex();

    // Overlay handlers
    const overlay = document.getElementById('overlay');
    const overlayContent = document.getElementById('overlayContent');
    const closeOverlay = document.getElementById('closeOverlay');
    function showOverlay(item, localSrc, remoteSrc) {
      overlayContent.innerHTML = '';
      const src = localSrc || remoteSrc || item.url;
      if (!src) return;
      // Try to render inline via object (best for SVG), fallback to img
      const obj = document.createElement('object');
      obj.type = 'image/svg+xml';
      obj.data = src;
      obj.style.maxWidth = '100%';
      obj.style.maxHeight = '80vh';
      obj.onerror = () => {
        // fallback to img
        const i = document.createElement('img');
        i.src = src;
        overlayContent.innerHTML = '';
        overlayContent.appendChild(i);
      };
      overlayContent.appendChild(obj);
      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }
    function hideOverlay() {
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
      overlayContent.innerHTML = '';
    }
    closeOverlay.addEventListener('click', hideOverlay);
    overlay.addEventListener('click', (e) => { if (e.target === overlay) hideOverlay(); });
  </script>
</body>
</html>
